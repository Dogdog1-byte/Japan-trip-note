<!DOCTYPE html>
<html class="light" lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>æ—…ç¨‹è¨˜å¸³ (å³æ™‚åŒæ­¥)</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "var(--primary-color, #2563EB)",
                        "primary-content": "#ffffff",
                        "background-light": "var(--background-light-color, #eff6ff)",
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "text-main-light": "#1e293b",
                        "text-main-dark": "#f8fafc",
                        "text-sub-light": "#64748b",
                        "text-sub-dark": "#94a3b8",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "Noto Sans TC", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "2xl": "2.5rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
        }

        .swipe-item {
            transition: transform 0.2s ease-out;
            will-change: transform;
            position: relative;
            z-index: 2;
        }

        .swipe-action {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            background: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1;
            border-radius: 0 1rem 1rem 0;
        }

        #modal-content {
            overscroll-behavior: contain;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark min-h-screen text-text-main-light dark:text-text-main-dark flex justify-center">
    <div
        class="relative flex h-full min-h-screen w-full max-w-md flex-col overflow-x-hidden bg-background-light dark:bg-background-dark pb-24">

        <!-- Header -->
        <header
            class="sticky top-0 z-20 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-sm px-6 pt-10 pb-4 border-b border-gray-100 dark:border-gray-800">
            <h1 class="text-3xl font-extrabold tracking-tight">æ—…ç¨‹è¨˜å¸³</h1>
            <p id="current-trip-name" class="text-sm text-primary font-bold mt-1">è«‹é¸æ“‡è¡Œç¨‹</p>
        </header>

        <main class="flex-1 px-4 pt-6">
            <!-- Summary Card -->
            <div id="summary-card"
                class="bg-primary text-primary-content p-6 rounded-3xl shadow-lg shadow-primary/20 mb-8 transition-all hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-xs font-bold opacity-80 uppercase tracking-wider">ç¸½æ”¯å‡º</p>
                        <h2 id="total-amount" class="text-4xl font-black mt-1">Â¥ 0</h2>
                    </div>
                    <span class="material-symbols-outlined text-3xl opacity-50">payments</span>
                </div>
                <div id="category-summary" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <!-- Categories -->
                </div>

                <div id="exchange-rate-info"
                    class="mt-4 pt-4 border-t border-white/20 text-[10px] font-bold opacity-80 flex justify-between items-center">
                    <div class="flex items-center gap-1">
                        <span>åŒ¯ç‡æ›´æ–°ï¼š<span id="rate-time">è¼‰å…¥ä¸­...</span></span>
                        <button onclick="window.fetchExchangeRate()"
                            class="hover:rotate-180 transition-transform duration-500 flex items-center">
                            <span class="material-symbols-outlined text-[14px]">refresh</span>
                        </button>
                    </div>
                    <span>1 JPY â‰ˆ <span id="jpy-twd-rate">...</span> TWD</span>
                </div>
            </div>

            <!-- Trip Selector (if needed) -->
            <div id="trip-selector" class="mb-6">
                <label class="block text-xs font-bold mb-2 ml-1 text-text-sub-light">é¸æ“‡è¡Œç¨‹æŸ¥çœ‹å¸³ç›®</label>
                <select id="tripSelect"
                    class="w-full bg-white dark:bg-surface-dark border-none rounded-2xl p-4 shadow-sm focus:ring-2 focus:ring-primary font-bold">
                    <option value="">-- è«‹é¸æ“‡è¡Œç¨‹ --</option>
                </select>
            </div>

            <!-- Expense List -->
            <div id="expenses-container" class="space-y-4 mb-8">
                <!-- Expenses Injected Here -->
            </div>

            <!-- Settlement Summary -->
            <div id="settlement-section" class="mb-20 hidden px-2">
                <div class="flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-primary">analytics</span>
                    <h3 class="text-lg font-bold">æ”¯å‡ºçµ±è¨ˆèˆ‡çµç®—</h3>
                </div>

                <!-- Pie Chart Container -->
                <div class="mb-8 bg-gray-50 dark:bg-black/10 rounded-3xl p-6 shadow-inner">
                    <div class="flex flex-col items-center">
                        <div class="h-44 w-full flex justify-center items-center">
                            <canvas id="expenseChart"></canvas>
                        </div>
                        <!-- Custom Legend -->
                        <div id="chart-legend" class="mt-4 flex flex-wrap justify-center gap-x-4 gap-y-2">
                            <!-- Legend items injected here -->
                        </div>
                    </div>
                </div>

                <!-- Individual Stats -->
                <div class="mb-6 overflow-x-auto pb-2">
                    <div id="member-stats-list" class="flex gap-3">
                        <!-- Individual Stats Injected Here -->
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-3 px-1">
                    <span class="text-[10px] font-black text-text-sub-light opacity-50 uppercase tracking-wider">å‚µå‹™çµç®—
                        (èª°è©²çµ¦èª°)</span>
                </div>
                <div id="settlement-list" class="space-y-3">
                    <!-- Settlement Items Injected Here -->
                </div>
            </div>

            <div id="empty-expenses" class="text-center py-20 opacity-40 italic">
                <span class="material-symbols-outlined text-6xl mb-4">receipt_long</span>
                <p>å°šæœªæœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„</p>
            </div>
        </main>

        <!-- FAB -->
        <div class="fixed bottom-24 right-6 z-40 md:right-1/2 md:translate-x-[200px]">
            <button id="addExpenseBtn" onclick="openModal()" disabled
                class="flex size-14 items-center justify-center rounded-full bg-primary text-primary-content shadow-lg shadow-primary/30 transition hover:scale-105 active:scale-95 disabled:grayscale disabled:opacity-50">
                <span class="material-symbols-outlined" style="font-size: 28px;">add</span>
            </button>
        </div>

        <!-- Add Expense Modal -->
        <div id="modal-overlay"
            class="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"
            onclick="closeModal()"></div>
        <div id="modal-content"
            class="fixed bottom-0 left-0 right-0 z-50 bg-surface-light dark:bg-surface-dark rounded-t-3xl flex flex-col transform translate-y-full transition-transform duration-300 max-h-[85vh] max-w-md mx-auto shadow-2xl">
            <!-- Header/Handle (Prevent browser swipe conflict) -->
            <div class="px-4 pt-3 pb-1 shrink-0 cursor-grab active:cursor-grabbing touch-none"
                ontouchstart="handleModalSwipeStart(event)" ontouchmove="handleModalSwipeMove(event)"
                ontouchend="handleModalSwipeEnd(event)">
                <div class="w-10 h-1 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mb-3"></div>
                <h3 class="text-base font-bold text-center">æ–°å¢æ”¯å‡º</h3>
            </div>

            <!-- Scrollable Body -->
            <div class="flex-1 overflow-y-auto px-4 pb-2">
                <form id="expenseForm" onsubmit="handleFormSubmit(event)" class="space-y-2.5">
                    <div class="grid grid-cols-2 gap-2.5">
                        <div>
                            <label
                                class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">é‡‘é¡
                                (Â¥)</label>
                            <input type="number" id="expAmount" required placeholder="0"
                                class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2 text-sm font-bold focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label
                                class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">é¡åˆ¥</label>
                            <select id="expCategory"
                                class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2 text-xs font-medium focus:ring-1 focus:ring-primary">
                                <option value="ç¾é£Ÿ">ğŸœ ç¾é£Ÿ</option>
                                <option value="äº¤é€š">ğŸš„ äº¤é€š</option>
                                <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="æ™¯é»">ğŸ—» æ™¯é»</option>
                                <option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                                <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">æ”¯å‡ºåç¨±</label>
                        <input type="text" id="expTitle" required placeholder="ä¾‹å¦‚ï¼šä¸€è˜­æ‹‰éºµ"
                            class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2 text-xs font-bold focus:ring-1 focus:ring-primary">
                    </div>

                    <div class="grid grid-cols-2 gap-2.5">
                        <div>
                            <label
                                class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">ä»˜æ¬¾äºº</label>
                            <select id="expPayer"
                                class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2 text-xs font-bold focus:ring-1 focus:ring-primary">
                                <!-- Members Injected Here -->
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">æ”¯ä»˜æ–¹å¼</label>
                            <select id="expMethod"
                                class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2 text-xs font-bold focus:ring-1 focus:ring-primary">
                                <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                                <option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡</option>
                                <option value="å…¶ä»–">ğŸ”˜ å…¶ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div
                        class="flex items-center gap-2 bg-gray-50 dark:bg-black/20 rounded-xl px-3 py-2 cursor-pointer hover:bg-primary/5 transition-colors">
                        <input type="checkbox" id="expTaxRefund" class="rounded text-primary focus:ring-primary size-4">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold">é€™ç­†æ”¯å‡ºåŒ…å«æ—¥æœ¬é€€ç¨… (10%)</span>
                            <span class="text-[9px] opacity-50">é–‹å•Ÿå¾Œå°‡æ–¼çµç®—æ™‚è‡ªå‹•æ‰£é™¤é è¨ˆé€€ç¨…é¡</span>
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">åˆ†å¸³æˆå“¡</label>
                        <div id="split-participants"
                            class="flex flex-wrap gap-1.5 bg-gray-50 dark:bg-black/20 rounded-xl p-2 min-h-[40px]">
                            <!-- Participant Checkboxes Injected Here -->
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">å‚™è¨»
                            (é¸å¡«)</label>
                        <textarea id="expDesc" placeholder="è¼¸å…¥å‚™è¨»å…§å®¹..." rows="1"
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2.5 text-sm focus:ring-1 focus:ring-primary overflow-hidden min-h-[40px]"></textarea>
                    </div>

                    <div>
                        <label
                            class="block text-[9px] font-black mb-0.5 ml-0.5 text-text-sub-light opacity-60 uppercase">åƒè€ƒç¶²å€
                            (é¸å¡«)</label>
                        <input type="url" id="expUrl" placeholder="https://..."
                            class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-2 text-[10px] focus:ring-1 focus:ring-primary">
                    </div>
                </form>
            </div>

            <!-- Fixed Footer -->
            <div
                class="px-4 py-3 border-t border-gray-50 dark:border-white/5 shrink-0 bg-surface-light/80 dark:bg-surface-dark/80 backdrop-blur-md">
                <button type="submit" form="expenseForm" id="saveExpenseBtn"
                    class="w-full py-3 bg-primary text-primary-content rounded-2xl font-bold text-sm shadow-lg shadow-primary/20 hover:scale-[1.01] active:scale-95 transition-all">
                    å„²å­˜æ”¯å‡º
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-surface-dark/80 backdrop-blur-xl border-t border-gray-100 dark:border-white/5 z-40">
            <div class="flex justify-around items-center h-16 px-2">
                <a href="trips.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-sub-light dark:text-text-sub-dark hover:text-text-main-light dark:hover:text-text-main-dark transition-colors">
                    <span class="material-symbols-outlined">home</span>
                    <span class="text-[10px] font-medium">é¦–é </span>
                </a>
                <a href="checklist.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-sub-light dark:text-text-sub-dark hover:text-text-main-light dark:hover:text-text-main-dark transition-colors">
                    <span class="material-symbols-outlined">checklist</span>
                    <span class="text-[10px] font-medium">å¾…è¾¦</span>
                </a>
                <a href="expenses.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-primary">
                    <span class="material-symbols-outlined font-variation-settings-fill">payments</span>
                    <span class="text-[10px] font-bold">è¨˜å¸³</span>
                </a>
                <a href="settings.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-sub-light dark:text-text-sub-dark hover:text-text-main-light dark:hover:text-text-main-dark transition-colors">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-[10px] font-medium">è¨­å®š</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Theme & Firebase Logic -->
    <script type="module">
        import './theme-manager.js';
        import {
            initApp, syncTripsList, updateTrip, getUserName,
            listenToTrip, saveExpense, updateTaxRefundStatus, deleteExpenseSingle,
            setSelectedTrip, getSelectedTrip
        } from './firebase-manager.js';

        let allTrips = [];
        let currentTripId = null;
        let currentTrip = null;
        let unlistenTrip = null;
        let expenseChart = null;

        // Auto Dark Mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        let exchangeRate = 0.22; // Default fallback
        let rateLastUpdated = "";

        window.fetchExchangeRate = async function () {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/JPY');
                const data = await res.json();
                if (data && data.rates && data.rates.TWD) {
                    exchangeRate = data.rates.TWD;
                    rateLastUpdated = new Date().toLocaleString('zh-TW', { hour12: false });
                    localStorage.setItem('cached_jpy_rate', exchangeRate);
                    localStorage.setItem('cached_rate_time', rateLastUpdated);
                    updateRateDisplay();
                }
            } catch (e) {
                console.error("Failed to fetch rate", e);
                exchangeRate = parseFloat(localStorage.getItem('cached_jpy_rate')) || 0.22;
                rateLastUpdated = localStorage.getItem('cached_rate_time') || "é›¢ç·šæ•¸æ“š";
                updateRateDisplay();
            }
        }

        function updateRateDisplay() {
            const rateEl = document.getElementById('jpy-twd-rate');
            const timeEl = document.getElementById('rate-time');
            if (rateEl) rateEl.innerText = exchangeRate.toFixed(4);
            if (timeEl) timeEl.innerText = rateLastUpdated;
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.fetchExchangeRate();
            const isConfigured = initApp();
            if (!isConfigured) {
                location.href = 'trips.html';
                return;
            }
            syncTripsList((trips) => {
                allTrips = trips;
                const select = document.getElementById('tripSelect');
                const savedId = getSelectedTrip();
                const currentVal = select.value;

                select.innerHTML = '<option value="">-- è«‹é¸æ“‡è¡Œç¨‹ --</option>';

                trips.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.name;
                    select.appendChild(opt);
                });

                // Priority: Current Selection > Saved Selection
                const idToSelect = currentVal || savedId;
                if (idToSelect && trips.find(t => t.id == idToSelect)) {
                    select.value = idToSelect;
                    if (currentTripId !== idToSelect) {
                        handleTripChange(idToSelect);
                    }
                }
            });

            function handleTripChange(id) {
                currentTripId = id;
                setSelectedTrip(id);

                if (!id) {
                    stopListening();
                    currentTrip = null;
                    renderExpenses();
                    document.getElementById('addExpenseBtn').disabled = true;
                    document.getElementById('summary-card').classList.add('hidden');
                    document.getElementById('current-trip-name').innerText = "è«‹é¸æ“‡è¡Œç¨‹";
                    document.getElementById('settlement-section').classList.add('hidden');
                    return;
                }

                document.getElementById('addExpenseBtn').disabled = false;
                startListening(id);
            }

            function startListening(id) {
                stopListening();
                // Listen specifically to this trip for real-time updates
                unlistenTrip = listenToTrip(id, (trip) => {
                    if (!trip) return;
                    currentTrip = trip;
                    document.getElementById('current-trip-name').innerText = trip.name;
                    updateParticipantList();
                    renderExpenses();
                });
            }

            function stopListening() {
                if (typeof unlistenTrip === 'function') {
                    unlistenTrip();
                    unlistenTrip = null;
                }
            }

            function updateParticipantList() {
                if (!currentTrip) return;
                const members = currentTrip.members || [getUserName()];

                // Update Split Checkboxes
                const container = document.getElementById('split-participants');
                container.innerHTML = members.map(m => `
                    <label class="flex items-center gap-1.5 bg-white dark:bg-white/5 px-2.5 py-1.5 rounded-lg border border-gray-100 dark:border-white/10 cursor-pointer active:scale-95 transition-transform">
                        <input type="checkbox" name="participant" value="${m}" checked 
                            class="rounded text-primary focus:ring-primary size-3.5">
                        <span class="text-xs font-bold">${m}</span>
                    </label>
                `).join('');

                // Update Paid By Dropdown
                const payerSelect = document.getElementById('expPayer');
                const oldPayer = payerSelect.value;
                payerSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
                if (oldPayer && members.includes(oldPayer)) {
                    payerSelect.value = oldPayer;
                } else {
                    payerSelect.value = getUserName();
                }
            }

            document.getElementById('tripSelect').addEventListener('change', (e) => {
                handleTripChange(e.target.value);
            });
        });

        window.openModal = function () {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            modalOverlay.classList.remove('hidden');
            void modalOverlay.offsetWidth;
            modalOverlay.classList.remove('opacity-0');
            modalContent.classList.remove('translate-y-full');
            modalContent.style.transform = ''; // Reset swipe transform
            modalContent.style.transition = ''; // Reset swipe transition
            document.getElementById('expenseForm').reset();
            updateParticipantList(); // Ensure fresh list
        }

        window.closeModal = function () {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            if (modalOverlay) modalOverlay.classList.add('opacity-0');
            if (modalContent) {
                modalContent.classList.add('translate-y-full');
                modalContent.style.transform = ''; // Reset swipe transform
            }
            setTimeout(() => {
                if (modalOverlay) modalOverlay.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scroll
            }, 300);
        }

        window.handleFormSubmit = async function (e) {
            e.preventDefault();
            if (!currentTripId) return;

            const saveBtn = document.getElementById('saveExpenseBtn');
            saveBtn.disabled = true;
            saveBtn.innerText = "å„²å­˜ä¸­...";

            try {
                const amountJpy = parseInt(document.getElementById('expAmount').value);
                const participants = Array.from(document.querySelectorAll('input[name="participant"]:checked')).map(i => i.value);
                const payer = document.getElementById('expPayer').value;

                if (isNaN(amountJpy) || amountJpy <= 0) {
                    alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
                    saveBtn.disabled = false;
                    saveBtn.innerText = "å„²å­˜æ”¯å‡º";
                    return;
                }

                if (participants.length === 0) {
                    alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†å¸³æˆå“¡");
                    saveBtn.disabled = false;
                    saveBtn.innerText = "å„²å­˜æ”¯å‡º";
                    return;
                }

                const expense = {
                    id: Date.now(),
                    amount: amountJpy,
                    amountTwd: Math.round(amountJpy * (exchangeRate || 0.22)),
                    category: document.getElementById('expCategory').value,
                    title: document.getElementById('expTitle').value,
                    method: document.getElementById('expMethod').value,
                    isTaxRefund: document.getElementById('expTaxRefund').checked,
                    desc: document.getElementById('expDesc').value,
                    url: document.getElementById('expUrl').value,
                    payer: payer,
                    participants: participants,
                    time: new Date().toISOString()
                };

                const success = await saveExpense(currentTripId, expense);
                if (success) {
                    window.closeModal();
                }
            } catch (err) {
                console.error("Save expense failed", err);
                alert("å„²å­˜å¤±æ•—ï¼š" + err.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "å„²å­˜æ”¯å‡º";
            }
        }

        window.deleteExpense = async function (expId) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            if (!currentTripId) return;

            const success = await deleteExpenseSingle(currentTripId, expId);
            if (!success) {
                alert("åˆªé™¤å¤±æ•—");
            }
        }

        window.toggleTaxRefund = async function (expId, isTaxRefund) {
            if (!currentTripId) return;
            try {
                await updateTaxRefundStatus(currentTripId, expId, isTaxRefund);
            } catch (err) {
                console.error("Toggle tax refund failed", err);
                alert("åˆ‡æ›å¤±æ•—ï¼š" + err.message);
                renderExpenses(); // Revert UI
            }
        }

        function renderExpenses() {
            const container = document.getElementById('expenses-container');
            const totalDisplay = document.getElementById('total-amount');
            const catSummary = document.getElementById('category-summary');
            const summaryCard = document.getElementById('summary-card');
            const empty = document.getElementById('empty-expenses');

            if (!currentTrip) {
                empty.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="material-symbols-outlined text-6xl mb-4 opacity-20">search</span>
                        <p class="font-bold text-text-sub-light">è«‹å¾ä¸Šæ–¹é¸å–®é¸æ“‡è¡Œç¨‹</p>
                        <p class="text-[10px] text-text-sub-light opacity-50">é¸å–å¾Œå³å¯æŸ¥çœ‹æ”¯å‡ºèˆ‡çµç®—</p>
                    </div>
                `;
                empty.classList.remove('hidden');
                container.innerHTML = '';
                summaryCard.classList.add('hidden');
                document.getElementById('settlement-section').classList.add('hidden');
                return;
            }

            const rawExpenses = currentTrip.expenses || [];
            const expensesArray = Array.isArray(rawExpenses) ? rawExpenses : Object.values(rawExpenses);

            if (expensesArray.length === 0) {
                empty.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="material-symbols-outlined text-6xl mb-4 opacity-20">receipt_long</span>
                        <p class="font-bold text-text-sub-light">å°šæœªæœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„</p>
                    </div>
                `;
                empty.classList.remove('hidden');
                container.innerHTML = '';
                summaryCard.classList.add('hidden');
                document.getElementById('settlement-section').classList.add('hidden');
                return;
            }

            empty.classList.add('hidden');
            summaryCard.classList.remove('hidden');

            const expenses = [...expensesArray].sort((a, b) => b.id - a.id);

            let totalJpy = 0;
            let totalTwd = 0;
            let totalRefund = 0;
            const cats = {};

            container.innerHTML = expenses.map(exp => {
                const refund = exp.isTaxRefund ? Math.round(exp.amount - (exp.amount / 1.1)) : 0;
                totalJpy += exp.amount;
                totalTwd += (exp.amountTwd || 0);
                totalRefund += refund;

                // For categories, use net amount to reflect real cost
                const netAmount = exp.amount - refund;
                cats[exp.category] = (cats[exp.category] || 0) + netAmount;

                const splitCount = exp.participants ? exp.participants.length : 1;
                const perPerson = Math.round(netAmount / splitCount);
                const splitText = exp.participants ? `ğŸ’¸ ${exp.payer} å¢Š / ${exp.participants.length}äººåˆ† (æ¯äºº Â¥${perPerson}${exp.isTaxRefund ? ' æ‰£é€€ç¨…' : ''})` : exp.payer;

                const refundTag = exp.isTaxRefund ? `
                    <div class="mt-1 flex items-center gap-1 text-[9px] font-bold text-green-600 dark:text-green-400 bg-green-500/10 px-1.5 py-0.5 rounded">
                        <span class="material-symbols-outlined text-[10px]">savings</span>
                        <span>é è¨ˆé€€ç¨… Â¥${refund.toLocaleString()}</span>
                    </div>
                ` : '';

                return `
                    <div class="swipe-container mb-4">
                        <div class="swipe-action" onclick="deleteExpense(${exp.id})">
                            <span class="material-symbols-outlined">delete</span>
                        </div>
                        <div class="swipe-item bg-white dark:bg-surface-dark p-4 shadow-sm border border-transparent hover:border-primary/20 transition group relative"
                             ontouchstart="handleSwipeStart(event)" 
                             ontouchmove="handleSwipeMove(event)" 
                             ontouchend="handleSwipeEnd(event, ${exp.id})">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                        <span class="material-symbols-outlined text-xl">${getCatIcon(exp.category)}</span>
                                    </div>
                                    <div class="min-w-0">
                                        <h4 class="font-bold text-base truncate">${exp.title}</h4>
                                        <p class="text-[10px] text-text-sub-light truncate">${exp.method || 'ç¾é‡‘'} Â· ${splitText}</p>
                                        ${refundTag}
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <label class="flex flex-col items-center gap-1 cursor-pointer group/tax">
                                        <span class="text-[8px] font-black opacity-30 group-hover/tax:opacity-60 transition-opacity">é€€ç¨…</span>
                                        <input type="checkbox" 
                                            ${exp.isTaxRefund ? 'checked' : ''} 
                                            onclick="toggleTaxRefund(${exp.id}, this.checked)"
                                            class="rounded border-gray-300 dark:border-white/10 text-primary focus:ring-primary size-4">
                                    </label>
                                    <div class="text-right flex flex-col items-end">
                                        <p class="font-black text-lg text-primary">Â¥ ${exp.amount.toLocaleString()}</p>
                                        <p class="text-[10px] text-text-sub-light">â‰ˆ NT$ ${(exp.amountTwd || 0).toLocaleString()}</p>
                                        ${exp.url ? `
                                            <a href="${exp.url}" target="_blank" class="mt-2 text-primary flex items-center gap-0.5">
                                                <span class="material-symbols-outlined text-xs">link</span>
                                                <span class="text-[10px] font-bold">æŸ¥çœ‹ç¶²å€</span>
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            ${exp.desc ? `
                                <div class="mt-3 pt-3 border-t border-gray-50 dark:border-white/5 text-[11px] text-text-sub-light italic leading-relaxed whitespace-pre-wrap">
                                    ${exp.desc}
                                </div>
                            ` : ''}
                            <button onclick="deleteExpense(${exp.id})" class="absolute -top-1 -right-1 size-6 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg z-10 md:flex hidden">
                                <span class="material-symbols-outlined text-xs">close</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            if (totalRefund > 0) {
                totalDisplay.innerHTML = `
                    <div class="flex flex-col">
                        <div class="flex items-baseline gap-2">
                            <span>Â¥ ${(totalJpy - totalRefund).toLocaleString()}</span>
                            <span class="text-xs opacity-50 font-normal">åŸåƒ¹ Â¥${totalJpy.toLocaleString()}</span>
                        </div>
                        <div class="text-[10px] bg-white/20 self-start px-2 py-0.5 rounded-full mt-1 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[12px]">account_balance_wallet</span>
                            é è¨ˆæ‰£é™¤é€€ç¨… Â¥${totalRefund.toLocaleString()}
                        </div>
                        <div class="text-xs opacity-70 font-bold mt-1">â‰ˆ NT$ ${totalTwd.toLocaleString()}</div>
                    </div>
                `;
            } else {
                totalDisplay.innerHTML = `<div>Â¥ ${totalJpy.toLocaleString()}</div><div class="text-xs opacity-70 font-bold mt-1">â‰ˆ NT$ ${totalTwd.toLocaleString()}</div>`;
            }

            catSummary.innerHTML = Object.entries(cats).map(([cat, amt]) => `
                <div class="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full flex items-center gap-1 shrink-0">
                    <span class="text-[10px] font-bold">${cat}</span>
                    <span class="text-[10px] font-black">Â¥${amt.toLocaleString()}</span>
                </div>
            `).join('');

            updateChart(cats);
            calculateSettlement();
        }

        function updateChart(cats) {
            const ctx = document.getElementById('expenseChart');
            const legendCon = document.getElementById('chart-legend');
            if (!ctx) return;

            const labels = Object.keys(cats);
            const data = Object.values(cats);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8BC34A', '#E91E63'];

            // Update Legend
            if (legendCon) {
                legendCon.innerHTML = labels.map((label, i) => `
                    <div class="flex items-center gap-1.5">
                        <div class="size-2.5 rounded-sm" style="background-color: ${colors[i % colors.length]}"></div>
                        <span class="text-[10px] font-bold opacity-70">${label}</span>
                    </div>
                `).join('');
            }

            if (expenseChart) {
                expenseChart.data.labels = labels;
                expenseChart.data.datasets[0].data = data;
                expenseChart.update();
            } else {
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => {
                                        sum += data;
                                    });
                                    let percentage = (value * 100 / sum).toFixed(0) + "%";
                                    return percentage;
                                },
                                display: (context) => {
                                    return context.dataset.data[context.dataIndex] > 0;
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                padding: 12,
                                cornerRadius: 10,
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        return ` ${label}: Â¥${value.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        cutout: '75%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            }
        }

        function calculateSettlement() {
            if (!currentTrip || !currentTrip.expenses) return;

            const balances = {};
            const totalPaid = {};
            const totalConsumed = {};
            const members = currentTrip.members || [getUserName()];

            members.forEach(m => {
                balances[m] = 0;
                totalPaid[m] = 0;
                totalConsumed[m] = 0;
            });

            const rawExpenses = currentTrip.expenses || [];
            const expensesArray = Array.isArray(rawExpenses) ? rawExpenses : Object.values(rawExpenses);

            expensesArray.forEach(exp => {
                const refund = exp.isTaxRefund ? Math.round(exp.amount - (exp.amount / 1.1)) : 0;
                const netAmount = exp.amount - refund;
                const amount = exp.amount; // Still use full amount for "Paid" tracking
                const payer = exp.payer;
                const participants = exp.participants || [payer];

                // Total Paid (Actual out-of-pocket at the time)
                totalPaid[payer] = (totalPaid[payer] || 0) + amount;

                // Individual Share (Calculated from net amount)
                const share = netAmount / participants.length;
                participants.forEach(p => {
                    totalConsumed[p] = (totalConsumed[p] || 0) + share;
                });
            });

            // Calculate Balances
            members.forEach(m => {
                balances[m] = totalPaid[m] - totalConsumed[m];
            });

            const settlementSection = document.getElementById('settlement-section');
            const settlementList = document.getElementById('settlement-list');

            const creditors = [];
            const debtors = [];

            for (const [name, balance] of Object.entries(balances)) {
                if (balance > 1) creditors.push({ name, balance });
                else if (balance < -1) debtors.push({ name, balance: -balance });
            }

            // Simple debt settlement algorithm
            const transactions = [];
            creditors.sort((a, b) => b.balance - a.balance);
            debtors.sort((a, b) => b.balance - a.balance);

            let i = 0, j = 0;
            while (i < creditors.length && j < debtors.length) {
                const amount = Math.min(creditors[i].balance, debtors[j].balance);
                transactions.push({ from: debtors[j].name, to: creditors[i].name, amount: Math.round(amount) });

                creditors[i].balance -= amount;
                debtors[j].balance -= amount;

                if (creditors[i].balance < 1) i++;
                if (debtors[j].balance < 1) j++;
            }

            // Render Member Stats
            const statsList = document.getElementById('member-stats-list');
            statsList.innerHTML = members.map(m => `
                <div class="bg-surface-light dark:bg-white/5 border border-gray-100 dark:border-white/10 p-3 rounded-2xl min-w-[140px] shrink-0">
                    <div class="text-[13px] font-black text-text-sub-light mb-2 truncate">${m}</div>
                    <div class="space-y-1">
                        <div class="flex justify-between items-end gap-2">
                            <span class="text-[9px] opacity-60">å¢Šä»˜</span>
                            <span class="text-xs font-bold font-mono">Â¥${Math.round(totalPaid[m]).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-end gap-2">
                            <span class="text-[9px] opacity-60">æ¶ˆè²»</span>
                            <span class="text-xs font-bold font-mono text-primary">Â¥${Math.round(totalConsumed[m]).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            if (transactions.length > 0 || members.some(m => totalPaid[m] > 0)) {
                settlementSection.classList.remove('hidden');
                settlementList.innerHTML = transactions.map(t => `
                    <div class="bg-primary/5 border border-primary/10 p-3 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm">${t.from}</span>
                            <span class="material-symbols-outlined text-xs text-text-sub-light">arrow_forward</span>
                            <span class="font-bold text-sm">${t.to}</span>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-primary text-base">Â¥ ${t.amount.toLocaleString()}</p>
                            <p class="text-[10px] text-text-sub-light">â‰ˆ NT$ ${Math.round(t.amount * exchangeRate).toLocaleString()}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                settlementSection.classList.add('hidden');
            }
        }

        function getCatIcon(cat) {
            const map = {
                'ç¾é£Ÿ': 'restaurant',
                'äº¤é€š': 'directions_transit',
                'è³¼ç‰©': 'shopping_bag',
                'æ™¯é»': 'landscape',
                'ä½å®¿': 'hotel',
                'å…¶ä»–': 'box'
            };
            return map[cat] || 'payments';
        }

        // Swipe-to-delete Logic
        let swipeStartX = 0;
        let currentSwipeEl = null;

        window.handleSwipeStart = function (e) {
            swipeStartX = e.touches[0].clientX;
            currentSwipeEl = e.currentTarget;
            currentSwipeEl.style.transition = 'none';
        }

        window.handleSwipeMove = function (e) {
            if (!currentSwipeEl) return;
            const diff = e.touches[0].clientX - swipeStartX;
            if (diff < 0) { // Swipe left
                const translate = Math.max(diff, -100);
                currentSwipeEl.style.transform = `translateX(${translate}px)`;
            } else {
                currentSwipeEl.style.transform = `translateX(0px)`;
            }
        }

        window.handleSwipeEnd = function (e, id) {
            if (!currentSwipeEl) return;
            const diff = e.changedTouches[0].clientX - swipeStartX;
            currentSwipeEl.style.transition = 'transform 0.2s ease-out';

            if (diff < -60) {
                currentSwipeEl.style.transform = `translateX(-80px)`;
            } else {
                currentSwipeEl.style.transform = `translateX(0)`;
            }
            currentSwipeEl = null;
        }

        // Modal Swipe-to-close Logic
        let modalSwipeStartY = 0;
        let isModalSwiping = false;

        window.handleModalSwipeStart = function (e) {
            modalSwipeStartY = e.touches[0].clientY;
            isModalSwiping = true;
            const modal = document.getElementById('modal-content');
            modal.style.transition = 'none';
        }

        window.handleModalSwipeMove = function (e) {
            if (!isModalSwiping) return;
            const currentY = e.touches[0].clientY;
            const diff = currentY - modalSwipeStartY;
            if (diff > 0) { // Only swipe down
                const modal = document.getElementById('modal-content');
                modal.style.transform = `translateY(${diff}px)`;
            }
        }

        window.handleModalSwipeEnd = function (e) {
            if (!isModalSwiping) return;
            isModalSwiping = false;
            const currentY = e.changedTouches[0].clientY;
            const diff = currentY - modalSwipeStartY;
            const modal = document.getElementById('modal-content');

            modal.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

            if (diff > 100) { // Distance threshold
                window.closeModal();
            } else {
                modal.style.transform = 'translateY(0)';
            }
        }
    </script>
</body>

</html>