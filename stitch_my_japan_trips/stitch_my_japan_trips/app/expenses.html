<!DOCTYPE html>
<html class="light" lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>æ—…ç¨‹è¨˜å¸³ (å³æ™‚åŒæ­¥)</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "var(--primary-color, #2563EB)",
                        "primary-content": "#ffffff",
                        "background-light": "var(--background-light-color, #eff6ff)",
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "text-main-light": "#1e293b",
                        "text-main-dark": "#f8fafc",
                        "text-sub-light": "#64748b",
                        "text-sub-dark": "#94a3b8",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "Noto Sans TC", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "2xl": "2.5rem", "full": "9999px" },
                },
            },
        }
    </script>
</head>

<body
    class="bg-background-light dark:bg-background-dark min-h-screen text-text-main-light dark:text-text-main-dark flex justify-center">
    <div
        class="relative flex h-full min-h-screen w-full max-w-md flex-col overflow-x-hidden bg-background-light dark:bg-background-dark pb-24">

        <!-- Header -->
        <header
            class="sticky top-0 z-20 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-sm px-6 pt-10 pb-4 border-b border-gray-100 dark:border-gray-800">
            <h1 class="text-3xl font-extrabold tracking-tight">æ—…ç¨‹è¨˜å¸³</h1>
            <p id="current-trip-name" class="text-sm text-primary font-bold mt-1">è«‹é¸æ“‡è¡Œç¨‹</p>
        </header>

        <main class="flex-1 px-4 pt-6">
            <!-- Summary Card -->
            <div id="summary-card"
                class="bg-primary text-primary-content p-6 rounded-3xl shadow-lg shadow-primary/20 mb-8 transition-all hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-xs font-bold opacity-80 uppercase tracking-wider">ç¸½æ”¯å‡º</p>
                        <h2 id="total-amount" class="text-4xl font-black mt-1">Â¥ 0</h2>
                    </div>
                    <span class="material-symbols-outlined text-3xl opacity-50">payments</span>
                </div>
                <div id="category-summary" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <!-- Categories -->
                </div>
            </div>

            <!-- Trip Selector (if needed) -->
            <div id="trip-selector" class="mb-6">
                <label class="block text-xs font-bold mb-2 ml-1 text-text-sub-light">é¸æ“‡è¡Œç¨‹æŸ¥çœ‹å¸³ç›®</label>
                <select id="tripSelect"
                    class="w-full bg-white dark:bg-surface-dark border-none rounded-2xl p-4 shadow-sm focus:ring-2 focus:ring-primary font-bold">
                    <option value="">-- è«‹é¸æ“‡è¡Œç¨‹ --</option>
                </select>
            </div>

            <!-- Expense List -->
            <div id="expenses-container" class="space-y-4">
                <!-- Expenses Injected Here -->
                <div id="empty-expenses" class="text-center py-20 opacity-40 italic">
                    <span class="material-symbols-outlined text-6xl mb-4">receipt_long</span>
                    <p>å°šæœªæœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„</p>
                </div>
            </div>
        </main>

        <!-- FAB -->
        <div class="fixed bottom-24 right-5 z-40">
            <button id="addExpenseBtn" onclick="openModal()" disabled
                class="flex size-14 items-center justify-center rounded-full bg-primary text-primary-content shadow-lg shadow-primary/30 transition hover:scale-105 active:scale-95 disabled:grayscale disabled:opacity-50">
                <span class="material-symbols-outlined" style="font-size: 28px;">add</span>
            </button>
        </div>

        <!-- Add Expense Modal -->
        <div id="modal-overlay"
            class="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"
            onclick="closeModal()"></div>
        <div id="modal-content"
            class="fixed bottom-0 left-0 right-0 z-50 bg-surface-light dark:bg-surface-dark rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300 max-h-[85vh] overflow-y-auto max-w-md mx-auto">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-6"></div>

            <h3 class="text-xl font-bold mb-6">æ–°å¢æ”¯å‡º</h3>

            <form id="expenseForm" onsubmit="handleFormSubmit(event)" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold mb-1.5 ml-1 text-text-sub-light">é‡‘é¡ (Â¥)</label>
                        <input type="number" id="expAmount" required placeholder="0"
                            class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-3 text-lg font-bold focus:ring-1 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1.5 ml-1 text-text-sub-light">é¡åˆ¥</label>
                        <select id="expCategory"
                            class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-3 font-medium focus:ring-1 focus:ring-primary">
                            <option value="ç¾é£Ÿ">ğŸœ ç¾é£Ÿ</option>
                            <option value="äº¤é€š">ğŸš„ äº¤é€š</option>
                            <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="æ™¯é»">ğŸ—» æ™¯é»</option>
                            <option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1.5 ml-1 text-text-sub-light">æ”¯å‡ºåç¨±</label>
                    <input type="text" id="expTitle" required placeholder="ä¾‹å¦‚ï¼šä¸€è˜­æ‹‰éºµ"
                        class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-4 text-base font-bold focus:ring-1 focus:ring-primary">
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1.5 ml-1 text-text-sub-light">ä»˜æ¬¾äºº</label>
                    <select id="expPayer"
                        class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-4 text-base font-bold focus:ring-1 focus:ring-primary">
                        <!-- Members Injected Here -->
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1.5 ml-1 text-text-sub-light">å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="expDesc" placeholder="åˆ·å¡æˆ–æ˜¯ä»˜ç¾..."
                        class="w-full bg-gray-50 dark:bg-black/20 border-none rounded-xl p-4 text-sm focus:ring-1 focus:ring-primary">
                </div>

                <div class="pt-4">
                    <button type="submit"
                        class="w-full py-4 bg-primary text-primary-content rounded-2xl font-bold text-lg shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-transform">
                        å„²å­˜æ”¯å‡º
                    </button>
                </div>
            </form>
        </div>

        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 z-30 w-full max-w-md bg-surface-light dark:bg-surface-dark border-t border-gray-100 dark:border-gray-800 pb-safe pt-2">
            <div class="flex justify-around items-center h-16 px-2">
                <a href="trips.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-sub-light dark:text-text-sub-dark hover:text-text-main-light dark:hover:text-text-main-dark transition-colors">
                    <span class="material-symbols-outlined">home</span>
                    <span class="text-[10px] font-medium">é¦–é </span>
                </a>
                <a href="checklist.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-sub-light dark:text-text-sub-dark hover:text-text-main-light dark:hover:text-text-main-dark transition-colors">
                    <span class="material-symbols-outlined">checklist</span>
                    <span class="text-[10px] font-medium">å¾…è¾¦</span>
                </a>
                <a href="expenses.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-primary">
                    <span class="material-symbols-outlined font-variation-settings-fill">payments</span>
                    <span class="text-[10px] font-bold">è¨˜å¸³</span>
                </a>
                <a href="settings.html"
                    class="flex flex-col items-center justify-center w-full h-full space-y-1 text-text-sub-light dark:text-text-sub-dark hover:text-text-main-light dark:hover:text-text-main-dark transition-colors">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-[10px] font-medium">è¨­å®š</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Theme & Firebase Logic -->
    <script type="module">
        import './theme-manager.js';
        import { initApp, syncTripsList, updateTrip, getUserName } from './firebase-manager.js';

        let allTrips = [];
        let currentTripId = null;
        let currentTrip = null;

        // Auto Dark Mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const isConfigured = initApp();
            if (!isConfigured) {
                location.href = 'trips.html';
                return;
            }

            // Listen to trips list to populate selector
            syncTripsList((trips) => {
                allTrips = trips;
                const select = document.getElementById('tripSelect');
                const oldVal = select.value;
                select.innerHTML = '<option value="">-- è«‹é¸æ“‡è¡Œç¨‹ --</option>';

                trips.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.name;
                    select.appendChild(opt);
                });

                if (oldVal && trips.find(t => t.id == oldVal)) {
                    select.value = oldVal;
                    // Real-time update members/expenses if they changed
                    currentTrip = trips.find(t => t.id == oldVal);
                    updatePayerList();
                    renderExpenses();
                }
            });

            function updatePayerList() {
                if (!currentTrip) return;
                const payerSelect = document.getElementById('expPayer');
                const oldPayer = payerSelect.value;
                const members = currentTrip.members || [getUserName()];
                payerSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
                if (members.includes(oldPayer)) {
                    payerSelect.value = oldPayer;
                }
            }

            document.getElementById('tripSelect').addEventListener('change', (e) => {
                const id = e.target.value;
                currentTripId = id;
                if (!id) {
                    currentTrip = null;
                    renderExpenses();
                    document.getElementById('addExpenseBtn').disabled = true;
                    document.getElementById('summary-card').classList.add('hidden');
                    document.getElementById('current-trip-name').innerText = "è«‹é¸æ“‡è¡Œç¨‹";
                    return;
                }

                currentTrip = allTrips.find(t => t.id == id);
                document.getElementById('addExpenseBtn').disabled = false;
                document.getElementById('current-trip-name').innerText = currentTrip.name;

                updatePayerList();
                renderExpenses();
            });
        });

        window.openModal = function () {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            modalOverlay.classList.remove('hidden');
            void modalOverlay.offsetWidth;
            modalOverlay.classList.remove('opacity-0');
            modalContent.classList.remove('translate-y-full');
            document.getElementById('expenseForm').reset();
        }

        window.closeModal = function () {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.add('translate-y-full');
            setTimeout(() => modalOverlay.classList.add('hidden'), 300);
        }

        window.handleFormSubmit = function (e) {
            e.preventDefault();
            if (!currentTrip) return;

            const expense = {
                id: Date.now(),
                amount: parseInt(document.getElementById('expAmount').value),
                category: document.getElementById('expCategory').value,
                title: document.getElementById('expTitle').value,
                desc: document.getElementById('expDesc').value,
                payer: document.getElementById('expPayer').value,
                time: new Date().toISOString()
            };

            if (!currentTrip.expenses) currentTrip.expenses = [];
            currentTrip.expenses.push(expense);

            updateTrip(currentTrip);
            renderExpenses();
            window.closeModal();
        }

        window.deleteExpense = function (expId) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            currentTrip.expenses = currentTrip.expenses.filter(e => e.id != expId);
            updateTrip(currentTrip);
            renderExpenses();
        }

        function renderExpenses() {
            const container = document.getElementById('expenses-container');
            const totalDisplay = document.getElementById('total-amount');
            const catSummary = document.getElementById('category-summary');
            const summaryCard = document.getElementById('summary-card');
            const empty = document.getElementById('empty-expenses');

            if (!currentTrip || !currentTrip.expenses || currentTrip.expenses.length === 0) {
                container.innerHTML = '';
                container.appendChild(empty);
                summaryCard.classList.add('hidden');
                return;
            }

            summaryCard.classList.remove('hidden');
            empty.classList.add('hidden');

            // Sort by time desc
            const expenses = [...currentTrip.expenses].sort((a, b) => b.id - a.id);

            let total = 0;
            const cats = {};

            container.innerHTML = expenses.map(exp => {
                total += exp.amount;
                cats[exp.category] = (cats[exp.category] || 0) + exp.amount;

                return `
                    <div class="bg-white dark:bg-surface-dark p-4 rounded-2xl shadow-sm border border-transparent hover:border-primary/20 transition group relative">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined text-xl">${getCatIcon(exp.category)}</span>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="font-bold text-base truncate">${exp.title}</h4>
                                    <p class="text-[10px] text-text-sub-light">${exp.payer} Â· ${new Date(exp.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-lg text-primary">Â¥ ${exp.amount.toLocaleString()}</p>
                                <p class="text-[10px] text-text-sub-light">${exp.category}</p>
                            </div>
                        </div>
                        <button onclick="deleteExpense(${exp.id})" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition shadow-lg">
                            <span class="material-symbols-outlined text-xs">close</span>
                        </button>
                    </div>
                `;
            }).join('');

            totalDisplay.innerText = `Â¥ ${total.toLocaleString()}`;

            catSummary.innerHTML = Object.entries(cats).map(([cat, amt]) => `
                <div class="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full flex items-center gap-1 shrink-0">
                    <span class="text-[10px] font-bold">${cat}</span>
                    <span class="text-[10px] font-black">Â¥${amt.toLocaleString()}</span>
                </div>
            `).join('');
        }

        function getCatIcon(cat) {
            const map = {
                'ç¾é£Ÿ': 'restaurant',
                'äº¤é€š': 'directions_transit',
                'è³¼ç‰©': 'shopping_bag',
                'æ™¯é»': 'landscape',
                'ä½å®¿': 'hotel',
                'å…¶ä»–': 'box'
            };
            return map[cat] || 'payments';
        }
    </script>
</body>

</html>